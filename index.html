<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Apex Live Blueprint — W.E. Trepp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f1c2e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Apex Live" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#0f1c2e;--fg:#e8eef5;--muted:#98a6bd;--line:#2a446b;
      --panel:#122940;--chip:#0c1d2f;--accent:#4c6fa8;--ok:#00b87a;--warn:#fbbf24;--danger:#f87171;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 14px}
    header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:14px}
    h1{font-size:18px;margin:0} .badge{font-size:12px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media (min-width:880px){.grid.two{grid-template-columns:1fr 1fr}}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
    h2{margin:0 0 8px 0;font-size:16px}
    h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
    .tag{background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:6px 10px;font-size:13px;display:inline-block;margin:2px 6px 2px 0}
    .chips{display:flex;flex-wrap:wrap}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:var(--chip);color:var(--muted);font-size:12px}
    .risk-low{color:#a7f3d0}.risk-medium{color:#fbbf24}.risk-high{color:#f87171}
    .barwrap{height:14px;background:var(--chip);border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#284a80,var(--accent));transition:width 900ms cubic-bezier(.2,.7,.2,1)}
    .trend{font-variant-numeric:tabular-nums}
    .trend.up{color:var(--ok)} .trend.down{color:var(--danger)}
    .list{display:grid;gap:6px}
    .fork{display:flex;justify-content:space-between;align-items:center;background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:13px}
    .fork .lbl{color:var(--fg)} .fork .meta{color:var(--muted)}
    .mermaid{overflow:auto}
    a.btn{color:#dfe9ff;text-decoration:none;border:1px solid var(--line);padding:8px 12px;border-radius:8px}
    .footer{margin:16px 0;color:var(--muted);font-size:12px;display:flex;gap:8px;flex-wrap:wrap}

    /* Animations & refresh flash */
    .flash { box-shadow: 0 0 0 0 rgba(76,111,168,.9); animation: flash 950ms ease-out 1; }
    @keyframes flash {
      0% { box-shadow: 0 0 0 0 rgba(76,111,168,.9); }
      70%{ box-shadow: 0 0 18px 6px rgba(76,111,168,.45); }
      100%{ box-shadow: 0 0 0 0 rgba(76,111,168,0); }
    }
    .changed { transition: color .35s ease; color:#a7d6ff !important; }

    /* Header right: refresh, spinner, admin, mode */
    .right{display:flex;align-items:center;gap:8px}
    button.refresh{background:transparent;border:1px solid var(--line);color:#e8eef5;border-radius:8px;padding:8px 12px;font-size:13px}
    .spin{width:16px;height:16px;border-radius:50%;border:2px solid rgba(223,233,255,.25);border-top-color:#dfe9ff;animation:spin 1s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}

    .admin-badge{display:none;margin-left:8px}
    .admin-badge a{color:#a7d6ff;text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:8px;font-size:12px;text-decoration:none}
    .mode-pill{display:inline-block;margin-left:8px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:500;position:relative}
    .mode-live{background:#065f46;color:#e8eef5} /* green */
    .mode-inline{background:#1e3a8a;color:#e8eef5} /* blue */
    .tooltip{cursor:help}
    .mode-pill .tiptext{visibility:hidden;width:220px;background-color:#122940;color:#e8eef5;text-align:left;border-radius:8px;padding:8px;position:absolute;z-index:10;bottom:125%;left:50%;margin-left:-110px;opacity:0;transition:opacity .3s;border:1px solid var(--line)}
    .mode-pill:hover .tiptext{visibility:visible;opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>⟁∞ WARREN EDWARD TREPP ∞⟁ — Apex Live</h1>
      <div class="badge">Apex Framework Architect • Creator of Hyper‑Life Systems</div>
    </div>
    <div class="right">
      <div class="badge" id="updated">Loading…</div>
      <div class="spin" id="spinner" aria-hidden="true"></div>
      <button class="refresh" id="refreshBtn" type="button">Refresh Now</button>
      <!-- Admin badge & mode pill will be injected here -->
    </div>
  </header>

  <!-- Session -->
  <div class="panel">
    <div class="chips">
      <span class="pill" id="title">Apex Live Blueprint</span>
      <span class="pill" id="owner">—</span>
      <span class="pill" id="role">—</span>
      <span class="pill" id="mode">Mode: —</span>
    </div>
  </div>

  <!-- Metrics -->
  <div class="grid two" style="margin-top:12px">
    <div class="panel" id="momPanel">
      <h2>Momentum</h2>
      <div style="display:flex;align-items:center;gap:10px;margin:6px 0 8px">
        <span id="momScore" style="font-size:22px">—%</span>
        <span id="momStatus" class="tag">—</span>
        <span id="momTrend" class="trend">—</span>
      </div>
      <div class="barwrap"><div id="momBar" class="bar"></div></div>
      <div class="badge" id="momNotes" style="margin-top:8px">—</div>
    </div>
    <div class="panel" id="healthPanel">
      <h2>Health Snapshot</h2>
      <div class="list" id="healthList"></div>
    </div>
  </div>

  <!-- Probabilities & Forks -->
  <div class="grid two" style="margin-top:12px">
    <div class="panel" id="pathsPanel">
      <h2 id="probmap">Three‑Path Outlook</h2>
      <div id="paths" class="chips"></div>
    </div>
    <div class="panel" id="forksPanel">
      <h2 id="forks">Fork Scan</h2>
      <div id="forkList" class="list"></div>
    </div>
  </div>

  <!-- Diagram -->
  <div class="panel" id="diagramPanel" style="margin-top:12px">
    <h2>Trajectory Diagram</h2>
    <div id="diagram" class="mermaid">graph TD; A[Loading…];</div>
  </div>

  <!-- Insights & Actions -->
  <div class="grid two" style="margin-top:12px">
    <div class="panel" id="insightsPanel">
      <h2>Insights</h2>
      <ul id="insights" style="margin:0 0 4px 16px; padding:0"></ul>
    </div>
    <div class="panel" id="actionsPanel">
      <h2>Next Actions</h2>
      <ol id="nextActions" style="margin:0 0 0 18px; padding:0"></ol>
    </div>
  </div>

  <div class="footer">
    <a class="btn" href="#probmap">Probmap</a>
    <a class="btn" href="#forks">Forks</a>
    <span class="badge">Session: <span id="sessionId">—</span></span>
  </div>
</div>

<!-- Inline data fallback (used if no continuity.json is present) -->
<script id="continuity-inline" type="application/json">
{
  "session": {
    "title": "Apex Live Blueprint",
    "owner": "⟁∞ Warren Edward Trepp ∞⟁",
    "role": "Apex Framework Architect — Creator of Hyper-Life Systems",
    "lastUpdated": "2025-08-11T18:00:00Z",
    "mode": "full",
    "session_id": "inline-000"
  },
  "momentum": { "score": 82, "status": "High", "trend": "+6", "notes": "Strong upward momentum; next 14 days carry the highest leverage." },
  "forkScan": [
    { "label": "Fork A (14d)",  "impact": "High",      "risk": "Medium", "probability": 64 },
    { "label": "Fork B (60d)",  "impact": "Medium",    "risk": "Low",    "probability": 23 },
    { "label": "Fork C (120d)", "impact": "Very High", "risk": "High",   "probability": 13 }
  ],
  "health": {
    "sleep": "7.5h — consistent",
    "nutrition": "High protein, steady carbs, micronutrient coverage",
    "mobility": "Daily stretch + 3× strength",
    "dopamine": "Regulated via 2× deep-work blocks",
    "stress": "Low and stable"
  },
  "insights": [
    "Early-day deep work drives the majority of compounding gains.",
    "Fork A aligns with energy profile; risk is acceptable.",
    "Hazards drop when evening plan ritual is consistent.",
    "Alliances unlock the fastest path to accelerated track."
  ],
  "nextActions": [
    "Lock 90-minute deep work at 07:30 for 10 days.",
    "Evening plan ritual (10 min) to cut friction by 8–12%.",
    "Outreach to alliance X and propose joint sprint.",
    "Run hazard simulation on Fork C and prepare counter."
  ]
}
</script>

<!-- Mermaid + App Logic (all-in-one) -->
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ startOnLoad: false, theme: "dark" });

  // CONFIG
  const DATA_URL = "./continuity.json"; // auto-detect same-folder JSON
  const REFRESH_INTERVAL_MS = 180_000;  // 3 minutes

  // DOM helpers
  const el = id => document.getElementById(id);
  const riskClass = (risk) => {
    if(!risk) return "";
    const r = risk.toLowerCase();
    return r.includes("high") ? "risk-high" : r.includes("medium") ? "risk-medium" : "risk-low";
  };
  const trendSpan = (t) => {
    if(!t || t === "—") return "—";
    const num = parseFloat(t);
    if (!isNaN(num)) return num >= 0 ? `<span class="trend up">▲ +${num}%</span>` : `<span class="trend down">▼ ${num}%</span>`;
    return t.trim().startsWith("+") ? `<span class="trend up">▲ ${t}</span>` : `<span class="trend down">▼ ${t.replace('-', '')}</span>`;
  };
  const buildMermaidFromForks = (forks=[]) => {
    const nodes = forks.map((f,i)=> {
      const id = `F${i}`;
      const label = `${f.label}\\nImpact: ${f.impact}\\nRisk: ${f.risk}\\nP: ${f.probability || 0}%`;
      return `${id}["${label}"]:::${(f.risk||'').toLowerCase().includes('high')?'risk':'alt'}`;
    }).join("\n  ");
    const edges = forks.map((f,i)=> `A --> F${i}`).join("\n  ");
    return `
flowchart TD
  A[Current Trajectory]:::core
  ${nodes ? nodes : 'F0["No forks found"]:::alt'}
  ${edges || 'A --> F0'}
  classDef core fill:#0f1c2e,stroke:#2a446b,color:#e8eef5,stroke-width:2px;
  classDef alt fill:#0d2034,stroke:#4c6fa8,color:#dfe9ff,stroke-width:1.6px;
  classDef risk fill:#3a0f12,stroke:#b94747,color:#ffe7e7,stroke-width:2px;
  linkStyle default stroke:#2a446b,stroke-width:1.4px;
    `;
  };

  // STATE
  let liveMode = false;
  let diagramKey = "";

  async function fetchExternal() {
    try {
      const res = await fetch(`${DATA_URL}?t=${Date.now()}`, {cache:"no-store"});
      if (!res.ok) throw new Error("status " + res.status);
      return await res.json();
    } catch { return null; }
  }
  function fetchInline() {
    const text = el("continuity-inline")?.textContent?.trim();
    return JSON.parse(text || "{}");
  }

  function showSpinner(ms=1000){
    const spinner = el("spinner");
    spinner.style.display = "inline-block";
    setTimeout(()=>{ spinner.style.display = "none"; }, ms);
  }
  function flashOnce(node){ if(!node) return; node.classList.add('flash'); setTimeout(()=>node.classList.remove('flash'), 950); }
  function setHTML(id, html){
    const node = el(id);
    if (!node) return;
    if (String(node.innerHTML).trim() !== String(html).trim()) { node.innerHTML = html; flashOnce(node); }
  }

  async function render(data){
    const s = data.session || {};
    el("title").textContent  = s.title || "Apex Live Blueprint";
    el("owner").textContent  = s.owner || "—";
    el("role").textContent   = s.role  || "—";
    el("updated").textContent= "Updated: " + new Date(s.lastUpdated || Date.now()).toLocaleString();
    el("mode").textContent   = "Mode: " + (s.mode || (liveMode ? "live" : "inline"));
    el("sessionId").textContent = s.session_id || "—";

    const m = data.momentum || {};
    const score = Math.max(0, Math.min(100, Number(m.score || 0)));
    el("momScore").textContent  = `${score}%`;
    el("momStatus").textContent = m.status || "—";
    el("momTrend").innerHTML    = trendSpan(m.trend || "—");
    el("momNotes").textContent  = m.notes || "—";
    requestAnimationFrame(()=>{ el("momBar").style.width = score + "%"; });

    const h = data.health || {};
    const healthHTML = [
      h.sleep     ? `<div class="tag">Sleep: ${h.sleep}</div>` : "",
      h.nutrition ? `<div class="tag">Nutrition: ${h.nutrition}</div>` : "",
      h.mobility  ? `<div class="tag">Mobility: ${h.mobility}</div>` : "",
      h.dopamine  ? `<div class="tag">Dopamine: ${h.dopamine}</div>` : "",
      h.stress    ? `<div class="tag">Stress: ${h.stress}</div>` : ""
    ].filter(Boolean).join(" ") || '<span class="badge">No health data</span>';
    setHTML("healthList", healthHTML);

    const forks = Array.isArray(data.forkScan) ? data.forkScan : [];
    const top3  = [...forks].sort((a,b)=> (b.probability||0) - (a.probability||0)).slice(0,3);
    setHTML("paths", top3.map(f =>
      `<span class="tag ${riskClass(f.risk)}">${f.label}: ${f.probability || 0}% — ${f.impact}</span>`
    ).join(" ") || '<span class="badge">No path data</span>');

    setHTML("forkList", forks.map(f => `
      <div class="fork">
        <div class="lbl">${f.label}</div>
        <div class="meta ${riskClass(f.risk)}">${f.impact} • Risk: ${f.risk} • P: ${f.probability || 0}%</div>
      </div>
    `).join("") || '<span class="badge">No forks yet</span>');

    const newKey = JSON.stringify(forks.map(f=>[f.label,f.impact,f.risk,f.probability]));
    if (newKey !== diagramKey) {
      const graphTxt = buildMermaidFromForks(forks);
      const { svg } = await mermaid.render("apexGraph", graphTxt);
      el("diagram").innerHTML = svg;
      diagramKey = newKey;
    }
  }

  async function tick(){
    showSpinner(1000); // ~1s
    const ext = await fetchExternal();
    liveMode = !!ext;
    await render(ext || fetchInline());
    updateAdminAndModeUI(); // refresh pill to reflect mode + enable click
  }

  // Expose tiny hooks for Admin/Mode pill
  window.APEX = {
    getMode: () => (liveMode ? 'live' : 'inline'),
    tick
  };

  // Inject Admin badge + Mode pill (and wire click-to-refresh in live)
  function updateAdminAndModeUI(){
    const headerRight = document.querySelector('.right');
    if (!headerRight) return;

    // Clear existing pills/badges (avoid duplicates)
    headerRight.querySelectorAll('.admin-badge, .mode-pill').forEach(n=>n.remove());

    // Admin persistence (?admin=1 / ?admin=0)
    const params = new URLSearchParams(location.search);
    const adminParam = params.get('admin');
    if (adminParam === '1') localStorage.setItem('apex_admin', '1');
    if (adminParam === '0') localStorage.removeItem('apex_admin');
    const isAdmin = localStorage.getItem('apex_admin') === '1' || adminParam === '1';

    if (isAdmin) {
      const badge = document.createElement('span');
      badge.className = 'admin-badge';
      badge.style.display = 'inline-block';
      badge.innerHTML = `<a href="updater.html" target="_blank" rel="noopener">Admin</a>`;
      headerRight.appendChild(badge);
    }

    const mode = liveMode ? 'live' : 'inline';
    const pill = document.createElement('span');
    pill.className = `mode-pill ${mode === 'live' ? 'mode-live' : 'mode-inline'} tooltip`;
    pill.innerHTML = `
      ${mode === 'live' ? 'Mode: Live' : 'Mode: Inline'}
      <span class="tiptext">${
        mode === 'live'
          ? 'Live mode: pulling continuity.json every 3 minutes. Tap to refresh now.'
          : 'Inline mode: using embedded JSON (use Refresh button).'
      }</span>
    `;
    headerRight.appendChild(pill);

    if (mode === 'live') {
      pill.style.cursor = 'pointer';
      pill.addEventListener('click', ()=>{
        try { tick(); } catch(e) {}
        pill.style.transform = 'scale(0.98)';
        setTimeout(()=>{ pill.style.transform = 'scale(1)'; }, 120);
      });
    }
  }

  // First load
  tick();

  // Manual refresh
  el("refreshBtn").addEventListener("click", tick);

  // Auto-refresh (only if external JSON reachable on first check)
  (async ()=>{
    const ext = await fetchExternal();
    liveMode = !!ext;
    updateAdminAndModeUI();
    if (liveMode && REFRESH_INTERVAL_MS > 0) {
      setInterval(tick, REFRESH_INTERVAL_MS);
    }
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
</html>