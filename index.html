<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apex Live — Mobile Updater</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0f1c2e" />
<style>
  :root{--bg:#0f1c2e;--fg:#e8eef5;--muted:#98a6bd;--line:#2a446b;--panel:#122940;--chip:#0c1d2f;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--accent:#4c6fa8}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:760px;margin:18px auto;padding:0 14px}
  h1{font-size:20px;margin:0 0 8px}
  .small{font-size:12px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{width:100%;background:#0c1d2f;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px}
  input[type=checkbox]{width:auto}
  .row{display:grid;gap:10px}
  @media(min-width:640px){.row.two{grid-template-columns:1fr 1fr}}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{background:#1c2f4a;color:#e8eef5;border:1px solid var(--line);border-radius:10px;padding:10px 14px;font-size:14px}
  button.primary{background:#24456f}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .msg{margin-top:8px;font-size:13px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .fork{display:grid;grid-template-columns:1.2fr .8fr .8fr .8fr;gap:8px}
  .forks{display:grid;gap:8px}
  .hr{height:1px;background:var(--line);margin:10px 0}
  .kvs{font-size:12px;color:var(--muted);line-height:1.4}
  .kvs b{color:#cfe3ff}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0c1d2f;border:1px solid var(--line);padding:10px 14px;border-radius:10px;display:none}
  .diff{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;background:#0c1d2f;border:1px solid var(--line);border-radius:10px;padding:10px;white-space:pre-wrap}
  .add{color:#a7f3d0} .del{color:#f87171}
</style>
</head>
<body>
<div class="wrap">
  <h1>⟁∞ APEX LIVE — Mobile Updater</h1>
  <div class="small">Edit <span class="pill">continuity.json</span> in your repo via GitHub API. Matches your dashboard schema.</div>

  <!-- Auth & Repo -->
  <div class="card">
    <div class="row two">
      <div><label>GitHub Username</label><input id="user" placeholder="e.g., warrennet"></div>
      <div><label>Repository</label><input id="repo" value="Apex-live"></div>
    </div>
    <div class="row two" style="margin-top:8px">
      <div><label>Path</label><input id="path" value="continuity.json"></div>
      <div><label>Token (fine‑grained, contents: rw)</label><input id="token" type="password" placeholder="paste token (not stored)"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="remember"> Remember token for this session (clears on tab close)</label>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="load" class="primary">Load</button>
      <button id="pull">Pull Latest</button>
      <button id="save" class="primary">Save to GitHub</button>
      <button id="download">Download JSON</button>
      <button id="revert">Undo to Last Loaded</button>
    </div>
    <div id="status" class="msg"></div>
    <div class="kvs" id="metaInfo" style="margin-top:6px"></div>
  </div>

  <!-- Session -->
  <div class="card">
    <div class="row two">
      <div><label>Last Updated (ISO)</label><input id="lastUpdated" placeholder="YYYY-MM-DDTHH:MM:SSZ"></div>
      <div><label>Mode</label><input id="mode" value="full"></div>
    </div>
    <div class="row two" style="margin-top:8px">
      <div><label>Session ID</label><input id="session_id" placeholder="2025-08-11-001"></div>
      <div><label>Owner</label><input id="owner" value="⟁∞ Warren Edward Trepp ∞⟁"></div>
    </div>
    <div class="btns" style="margin-top:8px">
      <button id="stamp">Timestamp Now (UTC)</button>
    </div>
  </div>

  <!-- Momentum -->
  <div class="card">
    <h3 style="margin:0 0 8px">Momentum</h3>
    <div class="row two">
      <div><label>Score (0–100)</label><input id="m_score" type="number" min="0" max="100" value="82"></div>
      <div><label>Trend (+/‑ number)</label><input id="m_trend" value="+6"></div>
    </div>
    <div class="row two" style="margin-top:8px">
      <div>
        <label>Status</label>
        <select id="m_status">
          <option>High</option><option>Medium</option><option>Low</option>
        </select>
      </div>
      <div><label>Note</label><input id="m_note" value="Strong upward momentum; next 14 days carry the highest leverage."></div>
    </div>
    <div class="btns" style="margin-top:8px">
      <button data-bump="+5" class="bump">+5 Momentum</button>
      <button data-bump="-5" class="bump">-5 Momentum</button>
      <button id="normalizeMomentum">Normalize (clamp 0–100)</button>
    </div>
  </div>

  <!-- Health -->
  <div class="card">
    <h3 style="margin:0 0 8px">Health</h3>
    <div class="row two">
      <div><label>Sleep</label><input id="h_sleep" value="7.5h — consistent"></div>
      <div><label>Nutrition</label><input id="h_nutrition" value="High protein, steady carbs, micronutrient coverage"></div>
    </div>
    <div class="row two" style="margin-top:8px">
      <div><label>Mobility</label><input id="h_mobility" value="Daily stretch + 3× strength"></div>
      <div><label>Dopamine</label><input id="h_dopamine" value="Regulated via 2× deep-work blocks"></div>
    </div>
    <div style="margin-top:8px"><label>Stress</label><input id="h_stress" value="Low and stable"></div>
  </div>

  <!-- Fork Scan -->
  <div class="card">
    <h3 style="margin:0 0 8px">Fork Scan (3 paths)</h3>
    <div id="forks" class="forks"></div>
    <div class="btns" style="margin-top:8px">
      <button id="resetForks">Reset 3 Defaults</button>
      <button id="sortForks">Sort by Probability</button>
      <button id="validateForks">Validate Forks</button>
    </div>
  </div>

  <!-- Insights / Actions -->
  <div class="card">
    <h3 style="margin:0 0 8px">Insights (one per line)</h3>
    <textarea id="insights" rows="4">Early-day deep work drives the majority of compounding gains.
Fork A aligns with energy profile; risk is acceptable.
Hazards drop when evening plan ritual is consistent.
Alliances unlock the fastest path to accelerated track.</textarea>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Next Actions (one per line)</h3>
    <textarea id="actions" rows="4">Lock 90-minute deep work at 07:30 for 10 days.
Evening plan ritual (10 min) to cut friction by 8–12%.
Outreach to alliance X and propose joint sprint.
Run hazard simulation on Fork C and prepare counter.</textarea>
  </div>

  <!-- Commit controls -->
  <div class="card">
    <div class="row two">
      <div><label>Commit Message</label><input id="commitMsg" value="mobile: update continuity.json"></div>
      <div><label>Auto Pull Interval (minutes)</label><input id="autoMin" type="number" min="0" value="3"></div>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="preview" class="primary">Preview Changes</button>
      <button id="save2">Save (Confirm)</button>
    </div>
    <div class="msg" id="valMsg"></div>
    <div class="hr"></div>
    <div class="diff" id="diffBox">Diff will appear here after “Preview Changes”.</div>
  </div>

</div>

<div id="toast" class="toast">Done</div>

<script>
  // ---------- helpers ----------
  const qs = id => document.getElementById(id);
  const setMsg = (el, msg, cls='') => { el.textContent = msg; el.className = 'msg ' + cls; };
  const toast = (t) => { const el = qs('toast'); el.textContent = t; el.style.display='block'; setTimeout(()=>el.style.display='none', 1500); };
  const b64encode = str => btoa(unescape(encodeURIComponent(str)));
  const b64decode = str => decodeURIComponent(escape(atob(str)));
  const isoNow = ()=> new Date().toISOString();

  // ---------- UI builders ----------
  function forkRow(f={label:"Fork A (14d)",impact:"High",risk:"Medium",probability:64}) {
    const wrap = document.createElement('div');
    wrap.className = 'fork';
    wrap.innerHTML = `
      <input class="f_label" placeholder="Label" value="${f.label||''}">
      <input class="f_impact" placeholder="Impact" value="${f.impact||''}">
      <input class="f_risk" placeholder="Risk" value="${f.risk||''}">
      <input class="f_prob" type="number" min="0" max="100" placeholder="Prob %" value="${f.probability||0}">
    `;
    return wrap;
  }
  function fillForks(arr) {
    const box = qs('forks');
    box.innerHTML = '';
    (arr && arr.length ? arr : [
      {label:"Fork A (14d)",impact:"High",risk:"Medium",probability:64},
      {label:"Fork B (60d)",impact:"Medium",risk:"Low",probability:23},
      {label:"Fork C (120d)",impact:"Very High",risk:"High",probability:13}
    ]).forEach(f=> box.appendChild(forkRow(f)));
  }

  // ---------- schema ----------
  function toJSON(){
    const insights = qs('insights').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const actions  = qs('actions').value.split('\n').map(s=>s.trim()).filter(Boolean);
    const forkNodes = Array.from(document.querySelectorAll('#forks .fork')).map(node => ({
      label: node.querySelector('.f_label').value,
      impact: node.querySelector('.f_impact').value,
      risk: node.querySelector('.f_risk').value,
      probability: Number(node.querySelector('.f_prob').value || 0)
    }));
    return {
      session: {
        title: "Apex Live Blueprint",
        owner: qs('owner').value || "⟁∞ Warren Edward Trepp ∞⟁",
        role: "Apex Framework Architect — Creator of Hyper-Life Systems",
        lastUpdated: qs('lastUpdated').value || isoNow(),
        mode: qs('mode').value || "full",
        session_id: qs('session_id').value || ""
      },
      momentum: { 
        score: Number(qs('m_score').value || 0),
        status: qs('m_status').value || "Medium",
        trend: qs('m_trend').value || "0",
        notes: qs('m_note').value || ""
      },
      forkScan: forkNodes,
      health: {
        sleep: qs('h_sleep').value,
        nutrition: qs('h_nutrition').value,
        mobility: qs('h_mobility').value,
        dopamine: qs('h_dopamine').value,
        stress: qs('h_stress').value
      },
      insights,
      nextActions: actions
    };
  }

  function fromJSON(data){
    const s = data.session || {};
    qs('lastUpdated').value = s.lastUpdated || '';
    qs('mode').value        = s.mode || 'full';
    qs('session_id').value  = s.session_id || '';
    qs('owner').value       = s.owner || '⟁∞ Warren Edward Trepp ∞⟁';

    const m = data.momentum || {};
    qs('m_score').value = m.score ?? 0;
    qs('m_trend').value = m.trend ?? '0';
    qs('m_status').value= m.status ?? 'Medium';
    qs('m_note').value  = m.notes  ?? '';

    fillForks(data.forkScan || []);

    const h = data.health || {};
    qs('h_sleep').value     = h.sleep     || '';
    qs('h_nutrition').value = h.nutrition || '';
    qs('h_mobility').value  = h.mobility  || '';
    qs('h_dopamine').value  = h.dopamine  || '';
    qs('h_stress').value    = h.stress    || '';

    qs('insights').value = (data.insights||[]).join('\n');
    qs('actions').value  = (data.nextActions||[]).join('\n');
  }

  // ---------- validation ----------
  function validateDraft(d){
    const errs = [];
    const score = Number(d.momentum?.score ?? NaN);
    if (Number.isNaN(score) || score < 0 || score > 100) errs.push('Momentum score must be 0–100.');
    (d.forkScan || []).forEach((f,i)=>{
      if (f.probability < 0 || f.probability > 100) errs.push(`Fork ${i+1} probability must be 0–100.`);
      if (!f.label) errs.push(`Fork ${i+1} needs a label.`);
    });
    if (!d.session?.lastUpdated) errs.push('Session.lastUpdated missing (use Timestamp Now).');
    return errs;
  }

  // ---------- diff ----------
  function diffJSON(a,b){
    // basic field-by-field diff; returns string
    const lines = [];
    function walk(prefix, va, vb){
      const aType = Object.prototype.toString.call(va);
      const bType = Object.prototype.toString.call(vb);
      if (aType !== bType){ lines.push(`~ ${prefix}: [type change]`); return; }
      if (va && typeof va === 'object' && !Array.isArray(va)){
        const keys = new Set([...Object.keys(va||{}), ...Object.keys(vb||{})]);
        for (const k of keys) walk(`${prefix}.${k}`, va?.[k], vb?.[k]);
      } else if (Array.isArray(va)){
        const len = Math.max(va.length, vb.length);
        for (let i=0;i<len;i++) walk(`${prefix}[${i}]`, va[i], vb[i]);
      } else {
        if (va !== vb){
          if (va === undefined) lines.push(`+ ${prefix}: ${JSON.stringify(vb)}`);
          else if (vb === undefined) lines.push(`- ${prefix}: ${JSON.stringify(va)}`);
          else lines.push(`- ${prefix}: ${JSON.stringify(va)}\n+ ${prefix}: ${JSON.stringify(vb)}`);
        }
      }
    }
    walk('$', a||{}, b||{});
    return lines.length ? lines.join('\n') : 'No changes.';
  }

  // ---------- GitHub API ----------
  async function ghGet(user, repo, path, token){
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}`, 'Accept':'application/vnd.github+json' } });
    if (!res.ok) throw new Error(`GET ${res.status}`);
    return res.json();
  }
  async function ghPut(user, repo, path, token, contentB64, sha, message){
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
    const body = JSON.stringify({ message: message || "mobile: update continuity.json", content: contentB64, sha });
    const res = await fetch(url, { method:'PUT', headers: { Authorization: `Bearer ${token}`, 'Accept':'application/vnd.github+json' }, body });
    if (!res.ok) throw new Error(`PUT ${res.status}`);
    return res.json();
  }

  // ---------- state ----------
  let lastLoaded = null;  // object
  let lastSHA = null;
  let autoTimer = null;

  function readAuth(){
    const user = qs('user').value.trim();
    const repo = qs('repo').value.trim();
    const path = qs('path').value.trim();
    const token= qs('token').value.trim();
    return {user,repo,path,token};
  }

  function rememberTokenMaybe(){
    if (qs('remember').checked){
      try { sessionStorage.setItem('apex_token', qs('token').value.trim()); } catch {}
    } else {
      try { sessionStorage.removeItem('apex_token'); } catch {}
    }
  }

  function restoreTokenIfAny(){
    try {
      const t = sessionStorage.getItem('apex_token');
      if (t) { qs('token').value = t; qs('remember').checked = true; }
    } catch {}
  }

  // ---------- autosave draft ----------
  function saveDraft(){
    try { localStorage.setItem('apex_draft', JSON.stringify(toJSON())); } catch {}
  }
  function restoreDraft(){
    try {
      const raw = localStorage.getItem('apex_draft');
      if (raw){
        const d = JSON.parse(raw);
        fromJSON(d);
        toast('Draft restored');
      }
    } catch {}
  }

  // ---------- event wiring ----------
  qs('stamp').onclick = ()=> { qs('lastUpdated').value = isoNow(); toast('Timestamp set'); };
  qs('normalizeMomentum').onclick = ()=>{
    let v = Number(qs('m_score').value||0);
    if (Number.isNaN(v)) v = 0;
    qs('m_score').value = Math.max(0, Math.min(100, v));
    toast('Momentum normalized');
  };
  document.querySelectorAll('.bump').forEach(b=>{
    b.onclick = ()=> {
      const delta = Number(b.dataset.bump||0);
      let v = Number(qs('m_score').value||0);
      v = Math.max(0, Math.min(100, v + delta));
      qs('m_score').value = v;
      qs('m_trend').value = (delta>=0?'+':'') + delta.toString();
      toast(`${delta>=0?'+':''}${delta} momentum`);
    };
  });

  qs('resetForks').onclick = ()=> { fillForks(); toast('Forks reset'); };
  qs('sortForks').onclick = ()=>{
    const nodes = Array.from(document.querySelectorAll('#forks .fork')).map(node => ({
      label: node.querySelector('.f_label').value,
      impact: node.querySelector('.f_impact').value,
      risk: node.querySelector('.f_risk').value,
      probability: Number(node.querySelector('.f_prob').value||0)
    }));
    nodes.sort((a,b)=> (b.probability||0) - (a.probability||0));
    fillForks(nodes);
    toast('Forks sorted by probability');
  };
  qs('validateForks').onclick = ()=>{
    const d = toJSON();
    const errs = validateDraft(d);
    setMsg(qs('valMsg'), errs.length? ('Validation: ' + errs.join(' | ')) : 'Validation: OK', errs.length?'err':'ok');
  };

  // Load / Pull / Save / Undo
  qs('load').onclick = async ()=>{
    try{
      setMsg(qs('status'),'Loading…');
      const {user,repo,path,token} = readAuth();
      if (!user || !repo || !path || !token) { setMsg(qs('status'),'Fill username, repo, path, token','warn'); return; }
      rememberTokenMaybe();

      const resp = await ghGet(user, repo, path, token);
      const jsonText = b64decode(resp.content);
      const data = JSON.parse(jsonText);
      fromJSON(data);
      lastLoaded = data;
      lastSHA = resp.sha;

      qs('metaInfo').innerHTML = `<b>Commit:</b> ${resp.sha.slice(0,7)} &nbsp; <b>Size:</b> ${resp.size} &nbsp; <b>Path:</b> ${resp.path}`;
      setMsg(qs('status'),'Loaded ✓','ok');
      toast('Loaded');
      // start/refresh auto-pull
      setupAutoPull();
    }catch(e){ console.error(e); setMsg(qs('status'),'Load failed: '+e.message,'err'); }
  };

  async function pullLatest(){
    try{
      const {user,repo,path,token} = readAuth();
      if (!user || !repo || !path || !token) return;
      const resp = await ghGet(user, repo, path, token);
      const data = JSON.parse(b64decode(resp.content));
      fromJSON(data);
      lastLoaded = data;
      lastSHA = resp.sha;
      qs('metaInfo').innerHTML = `<b>Commit:</b> ${resp.sha.slice(0,7)} &nbsp; <b>Size:</b> ${resp.size} &nbsp; <b>Path:</b> ${resp.path}`;
      setMsg(qs('status'),'Pulled latest ✓','ok');
      toast('Latest pulled');
    }catch(e){ console.warn('Pull latest failed', e.message); }
  }

  function setupAutoPull(){
    if (autoTimer) clearInterval(autoTimer);
    const mins = Math.max(0, Number(qs('autoMin').value || 0));
    if (mins > 0){
      autoTimer = setInterval(pullLatest, mins*60*1000);
    }
  }

  qs('pull').onclick = pullLatest;

  function draftAndValidate(){
    const d = toJSON();
    const errs = validateDraft(d);
    return { d, errs };
  }

  qs('preview').onclick = ()=>{
    const {d, errs} = draftAndValidate();
    if (errs.length){ setMsg(qs('valMsg'), 'Validation: '+errs.join(' | '), 'err'); return; }
    setMsg(qs('valMsg'), 'Validation: OK', 'ok');
    const before = lastLoaded || {};
    const delta = diffJSON(before, d);
    qs('diffBox').innerHTML = delta
      .replace(/^(\+ .*)$/gm,'<span class="add">$1</span>')
      .replace(/^(- .*)$/gm,'<span class="del">$1</span>');
  };

  async function doSave(){
    const {d, errs} = draftAndValidate();
    if (errs.length){ setMsg(qs('valMsg'), 'Validation: '+errs.join(' | '), 'err'); return; }

    try{
      setMsg(qs('status'),'Saving…');
      const {user,repo,path,token} = readAuth();
      if (!user || !repo || !path || !token) { setMsg(qs('status'),'Fill username, repo, path, token','warn'); return; }
      rememberTokenMaybe();

      // ensure timestamp updated
      if (!d.session.lastUpdated) d.session.lastUpdated = isoNow();

      const payload = JSON.stringify(d, null, 2);
      const sha = lastSHA || (await ghGet(user, repo, path, token)).sha; // fetch sha if missing
      const res = await ghPut(user, repo, path, token, b64encode(payload), sha, qs('commitMsg').value || undefined);
      setMsg(qs('status'), 'Saved ✓ — commit '+ (res.commit?.sha?.slice(0,7) || ''), 'ok');
      toast('Saved to GitHub');

      // update local state
      lastLoaded = d;
      lastSHA = res.content?.sha || res.commit?.sha || null;
      qs('metaInfo').innerHTML = `<b>Commit:</b> ${(res.commit?.sha||'').slice(0,7)} &nbsp; <b>Path:</b> ${qs('path').value}`;
    }catch(e){ console.error(e); setMsg(qs('status'),'Save failed: '+e.message,'err'); }
  }

  qs('save').onclick = doSave;
  qs('save2').onclick = doSave;

  qs('revert').onclick = ()=>{
    if (!lastLoaded){ setMsg(qs('status'),'Nothing to revert to','warn'); return; }
    fromJSON(lastLoaded);
    setMsg(qs('status'),'Reverted to last loaded ✓','ok');
  };

  qs('download').onclick = ()=>{
    const blob = new Blob([ JSON.stringify(toJSON(), null, 2) ], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'continuity.json';
    a.click();
    URL.revokeObjectURL(a.href);
    toast('Downloaded');
  };

  // autosave draft on changes (lightweight)
  document.addEventListener('input', ()=>{
    saveDraft();
  });

  // init UI
  fillForks();
  restoreTokenIfAny();
  restoreDraft();
</script>
</body><!-- APEX Admin Add‑On: auto‑fill + PIN gate + encrypted token memory -->
<script>
(function ApexAdminSecure(){
  // ---- Auto-fill defaults ----
  const DEFAULTS = { user: "warrennet", repo: "Apex-live", path: "continuity.json" };

  // Wait for drawer UI to exist (the unified file creates it at runtime)
  document.addEventListener('DOMContentLoaded', () => {
    const ensure = (id) => document.getElementById(id);

    // Helper: set default values if empty
    function applyDefaults() {
      const u = ensure('u_user'), r = ensure('u_repo'), p = ensure('u_path');
      if (u && !u.value) u.value = DEFAULTS.user;
      if (r && !r.value) r.value = DEFAULTS.repo;
      if (p && !p.value) p.value = DEFAULTS.path;
    }

    // ---------- PIN + Token Encryption (AES‑GCM via WebCrypto) ----------
    const enc = new TextEncoder(), dec = new TextDecoder();
    const LS_TOKEN_KEY = 'apex_token_enc'; // {salt,iv,ct} JSON
    const QS = (id) => document.getElementById(id);

    const bufToB64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
    const b64ToBuf = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));

    async function deriveKey(pin, saltBytes){
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt: saltBytes, iterations: 100000, hash: 'SHA-256'},
        keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
      );
    }
    async function encryptToken(pin, token){
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv   = crypto.getRandomValues(new Uint8Array(12));
      const key  = await deriveKey(pin, salt);
      const ct   = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(token));
      return { salt: bufToB64(salt), iv: bufToB64(iv), ct: bufToB64(ct) };
    }
    async function decryptToken(pin, blob){
      const salt = b64ToBuf(blob.salt), iv = b64ToBuf(blob.iv), ct = b64ToBuf(blob.ct);
      const key = await deriveKey(pin, salt);
      const pt  = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
      return dec.decode(pt);
    }

    async function secureSaveTokenFlow(){
      const tokenEl = QS('u_token'); if (!tokenEl) return;
      const token = tokenEl.value.trim();
      if (!token){ alert('Token is empty. Paste your token first.'); return false; }
      let pin = prompt('Set a PIN (4–8 digits) to protect your token:'); 
      if (!pin) return false;
      pin = pin.trim();
      if (!/^\d{4,8}$/.test(pin)){ alert('PIN must be 4–8 digits.'); return false; }
      try{
        const blob = await encryptToken(pin, token);
        localStorage.setItem(LS_TOKEN_KEY, JSON.stringify(blob));
        return true;
      }catch(e){
        console.warn(e); alert('Could not encrypt token on this device.');
        return false;
      }
    }

    async function secureLoadTokenFlow(){
      const tokenEl = QS('u_token'); if (!tokenEl) return;
      const raw = localStorage.getItem(LS_TOKEN_KEY);
      if (!raw) return false;
      try{
        const pin = prompt('Enter your PIN to unlock the token:');
        if (!pin) return false;
        const token = await decryptToken(pin.trim(), JSON.parse(raw));
        tokenEl.value = token;
        const remember = QS('u_remember'); if (remember) remember.checked = true;
        return true;
      }catch(e){
        console.warn(e); alert('Invalid PIN or token data.');
        return false;
      }
    }

    // Hook the "Remember token" checkbox to secure storage
    const remember = QS('u_remember');
    if (remember){
      remember.addEventListener('change',
</html>